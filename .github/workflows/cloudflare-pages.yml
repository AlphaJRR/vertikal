name: Cloudflare Pages Deploy (LOCKED)

on:
  workflow_dispatch:
    inputs:
      site:
        description: Target site
        required: true
        type: choice
        options:
          - vertikalapp
          - investors
          - creators
          - networks
          - demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Determine source directory
        id: source_dir
        run: |
          SITE="${{ github.event.inputs.site }}"
          case "$SITE" in
            vertikalapp)
              echo "dir=public" >> $GITHUB_OUTPUT
              ;;
            investors)
              echo "dir=public/investors" >> $GITHUB_OUTPUT
              ;;
            creators)
              echo "dir=public/creators" >> $GITHUB_OUTPUT
              ;;
            networks)
              echo "dir=public/networks" >> $GITHUB_OUTPUT
              ;;
            demo)
              echo "dir=public/demo" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "‚ùå Unknown site: $SITE"
              exit 1
              ;;
          esac
          echo "Source directory: $(cat $GITHUB_OUTPUT | grep dir= | cut -d= -f2)"

      - name: Prepare dist/ (enforce contract)
        run: |
          SOURCE_DIR="${{ steps.source_dir.outputs.dir }}"
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "‚ùå Source directory not found: $SOURCE_DIR"
            exit 1
          fi
          echo "üìÅ Copying $SOURCE_DIR/ to dist/ (enforcing contract)"
          rm -rf dist
          mkdir -p dist
          cp -r "$SOURCE_DIR"/* dist/
          echo "‚úÖ dist/ prepared ($(find dist -type f | wc -l) files)"

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå dist/ not found. Build contract violated."
            exit 1
          fi
          echo "‚úÖ dist/ verified ($(find dist -type f | wc -l) files)"

      - name: Determine project name
        id: project_name
        run: |
          SITE="${{ github.event.inputs.site }}"
          case "$SITE" in
            vertikalapp)
              echo "name=vertikalapp" >> $GITHUB_OUTPUT
              ;;
            investors)
              echo "name=investors-vertikalapp" >> $GITHUB_OUTPUT
              ;;
            creators)
              echo "name=creators-vertikalapp" >> $GITHUB_OUTPUT
              ;;
            networks)
              echo "name=networks-vertikalapp" >> $GITHUB_OUTPUT
              ;;
            demo)
              echo "name=demo-vertikal" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "‚ùå Unknown site: $SITE"
              exit 1
              ;;
          esac
          echo "Project name: $(cat $GITHUB_OUTPUT | grep name= | cut -d= -f2)"

      - name: Deploy to Cloudflare Pages
        run: |
          npx wrangler pages deploy dist \
            --project-name=${{ steps.project_name.outputs.name }} \
            --branch=production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

