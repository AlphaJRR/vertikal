name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
  pull_request:

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy-vertikalapp:
    name: Deploy vertikalapp
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Step 2: Monorepo detection - deploy only if changed
      - name: Determine if this project changed
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git fetch --depth=2 origin ${{ github.ref }}

          CHANGED=$(git diff --name-only HEAD^ HEAD | grep "^public/" || true)

          # Check if root public files changed (not in subdirectories)
          if echo "$CHANGED" | grep -q "^public/[^/]*$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not changed
        if: steps.changed.outputs.changed == 'false'
        run: echo "No changes detected for vertikalapp. Skipping."

      # Step 1: Build caching foundation (no-op for pure static, ready for future builds)
      - name: Set up Node with cache (if Node project)
        if: steps.changed.outputs.changed == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify directory exists
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ ! -d "./public" ]; then
            echo "Directory ./public does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.changed.outputs.changed == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: vertikalapp
          directory: ./public
          branch: ${{ github.ref_name }}
          commitHash: ${{ github.sha }}

  deploy-investors:
    name: Deploy investors-vertikalapp
    runs-on: ubuntu-latest
    needs: deploy-vertikalapp
    steps:
      - uses: actions/checkout@v4

      # Step 2: Monorepo detection - deploy only if changed
      - name: Determine if this project changed
        id: changed
        env:
          PROJECT_DIR: investors
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git fetch --depth=2 origin ${{ github.ref }}

          CHANGED=$(git diff --name-only HEAD^ HEAD | grep "^public/" || true)

          if echo "$CHANGED" | grep -q "^public/$PROJECT_DIR"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not changed
        if: steps.changed.outputs.changed == 'false'
        run: echo "No changes detected for investors-vertikalapp. Skipping."

      - name: Set up Node with cache (if Node project)
        if: steps.changed.outputs.changed == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify directory exists
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ ! -d "./public/investors" ]; then
            echo "Directory ./public/investors does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.changed.outputs.changed == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: investors-vertikalapp
          directory: ./public/investors
          branch: ${{ github.ref_name }}
          commitHash: ${{ github.sha }}

  deploy-creators:
    name: Deploy creators-vertikalapp
    runs-on: ubuntu-latest
    needs: deploy-investors
    steps:
      - uses: actions/checkout@v4

      # Step 2: Monorepo detection - deploy only if changed
      - name: Determine if this project changed
        id: changed
        env:
          PROJECT_DIR: creators
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git fetch --depth=2 origin ${{ github.ref }}

          CHANGED=$(git diff --name-only HEAD^ HEAD | grep "^public/" || true)

          if echo "$CHANGED" | grep -q "^public/$PROJECT_DIR"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not changed
        if: steps.changed.outputs.changed == 'false'
        run: echo "No changes detected for creators-vertikalapp. Skipping."

      - name: Set up Node with cache (if Node project)
        if: steps.changed.outputs.changed == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify directory exists
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ ! -d "./public/creators" ]; then
            echo "Directory ./public/creators does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.changed.outputs.changed == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: creators-vertikalapp
          directory: ./public/creators
          branch: ${{ github.ref_name }}
          commitHash: ${{ github.sha }}

  deploy-networks:
    name: Deploy networks-vertikalapp
    runs-on: ubuntu-latest
    needs: deploy-creators
    steps:
      - uses: actions/checkout@v4

      # Step 2: Monorepo detection - deploy only if changed
      - name: Determine if this project changed
        id: changed
        env:
          PROJECT_DIR: networks
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git fetch --depth=2 origin ${{ github.ref }}

          CHANGED=$(git diff --name-only HEAD^ HEAD | grep "^public/" || true)

          if echo "$CHANGED" | grep -q "^public/$PROJECT_DIR"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not changed
        if: steps.changed.outputs.changed == 'false'
        run: echo "No changes detected for networks-vertikalapp. Skipping."

      - name: Set up Node with cache (if Node project)
        if: steps.changed.outputs.changed == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify directory exists
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ ! -d "./public/networks" ]; then
            echo "Directory ./public/networks does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.changed.outputs.changed == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: networks-vertikalapp
          directory: ./public/networks
          branch: ${{ github.ref_name }}
          commitHash: ${{ github.sha }}

  deploy-beta:
    name: Deploy beta-vertikalapp
    runs-on: ubuntu-latest
    needs: deploy-networks
    steps:
      - uses: actions/checkout@v4

      # Step 2: Monorepo detection - deploy only if changed
      - name: Determine if this project changed
        id: changed
        env:
          PROJECT_DIR: beta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git fetch --depth=2 origin ${{ github.ref }}

          CHANGED=$(git diff --name-only HEAD^ HEAD | grep "^public/" || true)

          if echo "$CHANGED" | grep -q "^public/$PROJECT_DIR"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not changed
        if: steps.changed.outputs.changed == 'false'
        run: echo "No changes detected for beta-vertikalapp. Skipping."

      - name: Set up Node with cache (if Node project)
        if: steps.changed.outputs.changed == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify directory exists
        if: steps.changed.outputs.changed == 'true'
        run: |
          if [ ! -d "./public/beta" ]; then
            echo "Directory ./public/beta does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.changed.outputs.changed == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: beta-vertikalapp
          directory: ./public/beta
          branch: ${{ github.ref_name }}
          commitHash: ${{ github.sha }}

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs:
      - deploy-vertikalapp
      - deploy-investors
      - deploy-creators
      - deploy-networks
      - deploy-beta
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RESULT_VERTIKALAPP: ${{ needs.deploy-vertikalapp.result }}
          RESULT_INVESTORS: ${{ needs.deploy-investors.result }}
          RESULT_CREATORS: ${{ needs.deploy-creators.result }}
          RESULT_NETWORKS: ${{ needs.deploy-networks.result }}
          RESULT_BETA: ${{ needs.deploy-beta.result }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification."
            exit 0
          fi

          OVERALL_STATUS="success"
          for r in "$RESULT_VERTIKALAPP" "$RESULT_INVESTORS" "$RESULT_CREATORS" "$RESULT_NETWORKS" "$RESULT_BETA"; do
            if [ "$r" != "success" ]; then
              OVERALL_STATUS="failure"
            fi
          done

          payload=$(cat <<EOF
          {
            "text": "*Cloudflare Pages deployment* for \`$REPO\` on \`$REF\` finished with *$OVERALL_STATUS*.\n
            *Jobs:*
            • vertikalapp: $RESULT_VERTIKALAPP
            • investors-vertikalapp: $RESULT_INVESTORS
            • creators-vertikalapp: $RESULT_CREATORS
            • networks-vertikalapp: $RESULT_NETWORKS
            • beta-vertikalapp: $RESULT_BETA\n
            Details: $RUN_URL"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
