name: Advanced Cloudflare Deploy (Canary + Blue/Green)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target sites (all, vertikalapp, investors, creators, networks)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - vertikalapp
          - investors
          - creators
          - networks
      mode:
        description: 'Deployment mode (canary, blue, green, production)'
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - blue
          - green
          - production
      branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'
        type: string

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    name: Deploy ${{ inputs.target }} (${{ inputs.mode }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: vertikalapp
            directory: ./public
            project_suffix: vertikalapp
          - target: investors
            directory: ./public/investors
            project_suffix: investors-vertikalapp
          - target: creators
            directory: ./public/creators
            project_suffix: creators-vertikalapp
          - target: networks
            directory: ./public/networks
            project_suffix: networks-vertikalapp
      fail-fast: false
    steps:
      - name: Check if target matches
        id: should_deploy
        run: |
          if [ "${{ inputs.target }}" = "all" ] || [ "${{ inputs.target }}" = "${{ matrix.target }}" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repo
        if: steps.should_deploy.outputs.deploy == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Set up Node with cache
        if: steps.should_deploy.outputs.deploy == 'true' && hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Determine project name
        if: steps.should_deploy.outputs.deploy == 'true'
        id: project_name
        run: |
          MODE="${{ inputs.mode }}"
          SUFFIX="${{ matrix.project_suffix }}"
          
          if [ "$MODE" = "production" ]; then
            PROJECT_NAME="$SUFFIX"
          else
            PROJECT_NAME="${SUFFIX}-${MODE}"
          fi
          
          echo "name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Project name: $PROJECT_NAME"

      - name: Verify directory exists
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          if [ ! -d "${{ matrix.directory }}" ]; then
            echo "Directory ${{ matrix.directory }} does not exist"
            exit 1
          fi

      - name: Publish to Cloudflare Pages
        if: steps.should_deploy.outputs.deploy == 'true'
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ steps.project_name.outputs.name }}
          directory: ${{ matrix.directory }}
          branch: ${{ inputs.branch }}
          commitHash: ${{ github.sha }}

      - name: Deployment summary
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          echo "âœ… Deployed ${{ matrix.target }} to ${{ steps.project_name.outputs.name }}"

  notify:
    name: Notify deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TARGET: ${{ inputs.target }}
          MODE: ${{ inputs.mode }}
          BRANCH: ${{ inputs.branch }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification."
            exit 0
          fi

          payload=$(cat <<EOF
          {
            "text": "*Cloudflare Advanced Deployment* for \`${{ github.repository }}\`\n
            *Target:* $TARGET\n
            *Mode:* $MODE\n
            *Branch:* $BRANCH\n
            *Status:* ${{ needs.deploy.result }}\n
            Details: $RUN_URL"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

