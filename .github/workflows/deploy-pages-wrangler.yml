name: Deploy to Cloudflare Pages (Wrangler - Mode B)

# GOLDEN WORKFLOW - Uses Wrangler CLI directly for API-only Pages projects
# This workflow is designed for Cloudflare Pages projects with NO Git connection
# Mode B: API/Wrangler-only deployment

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target sites (all, vertikalapp, investors, creators, networks)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - vertikalapp
          - investors
          - creators
          - networks
  push:
    branches:
      - main

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  deploy:
    name: Deploy ${{ inputs.target || 'all' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: vertikalapp
            project_name: vertikalapp
            directory: ./public
          - target: investors
            project_name: investors-vertikalapp
            directory: ./public/investors
          - target: creators
            project_name: creators-vertikalapp
            directory: ./public/creators
          - target: networks
            project_name: networks-vertikalapp
            directory: ./public/networks
      fail-fast: false
    steps:
      - name: Check if target matches
        id: should_deploy
        run: |
          TARGET="${{ inputs.target || 'all' }}"
          if [ "$TARGET" = "all" ] || [ "$TARGET" = "${{ matrix.target }}" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repo
        if: steps.should_deploy.outputs.deploy == 'true'
        uses: actions/checkout@v4

      - name: Verify directory exists
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          if [ ! -d "${{ matrix.directory }}" ]; then
            echo "‚ùå ERROR: Directory ${{ matrix.directory }} does not exist"
            exit 1
          fi
          echo "‚úÖ Directory verified: ${{ matrix.directory }}"

      - name: Install Wrangler CLI
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          npm install -g wrangler@latest
          wrangler --version

      - name: Deploy to Cloudflare Pages (Wrangler)
        if: steps.should_deploy.outputs.deploy == 'true'
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "üöÄ Deploying ${{ matrix.target }} to ${{ matrix.project_name }}"
          echo "üìÅ Directory: ${{ matrix.directory }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          
          # Wrangler Pages deploy command (Mode B - API-only)
          wrangler pages deploy "${{ matrix.directory }}" \
            --project-name="${{ matrix.project_name }}" \
            --branch="${{ github.ref_name }}" \
            --commit-hash="${{ github.sha }}" \
            --commit-message="${{ github.event.head_commit.message || 'Deploy from GitHub Actions' }}"
          
          echo "‚úÖ Deployment completed for ${{ matrix.project_name }}"

      - name: Deployment summary
        if: steps.should_deploy.outputs.deploy == 'true'
        run: |
          echo "‚úÖ Successfully deployed ${{ matrix.target }}"
          echo "   Project: ${{ matrix.project_name }}"
          echo "   Directory: ${{ matrix.directory }}"
          echo "   Branch: ${{ github.ref_name }}"

  notify:
    name: Notify deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TARGET: ${{ inputs.target || 'all' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification."
            exit 0
          fi

          payload=$(cat <<EOF
          {
            "text": "*Cloudflare Pages Deployment (Wrangler)* for \`${{ github.repository }}\`\n
            *Target:* $TARGET\n
            *Branch:* ${{ github.ref_name }}\n
            *Status:* ${{ needs.deploy.result }}\n
            Details: $RUN_URL"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

